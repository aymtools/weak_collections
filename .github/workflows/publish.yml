# .github/workflows/publish.yml
# È¢ÑÂèëÂ∏É vX.Y.Z-(pre/dev/beta/rc).X Âè™Ê£ÄÊü•‰∏çÂèëÂ∏É
# Ê≠£ÂºèÂèëÂ∏É vX.Y.Z ‰ºöÊâßË°åÊâÄÊúâÊ£ÄÊü•Âπ∂‰ΩøÁî®OIDCÁöÑÊñπÂºèÂèëÂ∏É
name: Publish to pub.dev

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*.*'

jobs:
  publish:
    name: 'Publish to pub.dev'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      # ---------------------------------
      #  Checkout
      # ---------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up the Dart SDK and provision the OIDC token used for publishing.
      # The `dart` command from this step will be shadowed by the one from the
      # Flutter SDK below.
      - uses: dart-lang/setup-dart@e51d8e571e22473a2ddebf0ef8a2123f0ab2c02c

      # ---------------------------------
      #  Install yq
      # ---------------------------------
      - name: Install yq
        run: sudo snap install yq
      # ---------------------------------
      #  Parse tag & auto detect package
      # ---------------------------------
      - name: Parse tag
        id: tag
        run: |
          TAG="${{ github.ref_name }}"

          # single repo: vX.Y.Z
          if [[ "$TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            echo "::error::Invalid tag format: $TAG"
            exit 1
          fi

          if [[ "$VERSION" =~ - ]]; then
            RELEASE=false
          else
            RELEASE=true
          fi
          
          if [ "$RELEASE" == "false" ]; then
            REGEX='^v[0-9]+\.[0-9]+\.[0-9]+-(pre|dev|beta|rc)\.[0-9]+$'
            if [[ ! "$TAG" =~ $REGEX ]]; then
              echo "::error::Invalid tag: $TAG"
              exit 1
            fi
          fi
          
          
          if [ ! -f "pubspec.yaml" ]; then
            echo "::error::pubspec.yaml not found "
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release=$RELEASE" >> $GITHUB_OUTPUT

          echo "üè∑ Version : $VERSION"
          echo "üöÄ Release : $RELEASE"

      # ---------------------------------
      #  Ê†°È™å pubspec ‚Üî tag
      # ---------------------------------
      - name: Validate pubspec version
        run: |
          PUBSPEC_VERSION=$(yq '.version' pubspec.yaml)
          if [ "$PUBSPEC_VERSION" != "${{ steps.tag.outputs.version }}" ]; then
            echo "::error::Tag version does not match pubspec.yaml"
            exit 1
          fi

      # ---------------------------------
      #  Extract minimum SDK
      # ---------------------------------
      - name: Extract minimum SDK
        id: min_sdk
        run: |
          CONSTRAINT=$(yq '.environment.sdk' pubspec.yaml)

          if [ -z "$CONSTRAINT" ] || [ "$CONSTRAINT" = "null" ]; then
            echo "::error::Missing environment constraint"
            exit 1
          fi

          MIN=$(echo "$CONSTRAINT" | sed -E 's/.*>=([0-9]+\.[0-9]+\.[0-9]+).*/\1/')
          echo "version=$MIN" >> $GITHUB_OUTPUT
          echo "üîΩ Minimum Dart SDK: $MIN"

      # ---------------------------------
      #  Setup command aliases
      # ---------------------------------
      - name: Setup commands
        id: cmds
        run: |
          echo "pub=dart pub" >> $GITHUB_OUTPUT
          echo "analyze=dart analyze" >> $GITHUB_OUTPUT
          echo "test=dart test --enable-vm-service -p vm " >> $GITHUB_OUTPUT
          echo "format=dart format --output=none --set-exit-if-changed lib" >> $GITHUB_OUTPUT

      # =====================================================================
      #  Setup minimum Dart SDK
      # =====================================================================
      - name: Setup minimum Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: ${{ steps.min_sdk.outputs.version }}

      # =====================================================================
      #  Minimum SDK analyze
      # =====================================================================
      - name: Analyze (minimum SDK)
        run: |
          ${{ steps.cmds.outputs.pub }} get
          ${{ steps.cmds.outputs.analyze }} --fatal-infos --fatal-warnings  lib 
          ${{ steps.cmds.outputs.analyze }}

      # =====================================================================
      #  Clear Minimum SDK
      # =====================================================================
      - name: Clean lock file and SDK cache
        run: |
          rm -f pubspec.lock
          rm -rf .dart_tool
          rm -f /home/runner/work/_temp/dartsdk-linux-x64-release.zip

      # =====================================================================
      #  Setup stable Dart SDK
      # =====================================================================
      - name: Setup stable Dart SDK
        uses: dart-lang/setup-dart@v1

      # =====================================================================
      #  Stable SDK analyze
      # =====================================================================
      - name: Analyze (stable SDK)
        run: |
          ${{ steps.cmds.outputs.pub }} get
          ${{ steps.cmds.outputs.analyze }} --fatal-infos --fatal-warnings  lib
          ${{ steps.cmds.outputs.analyze }}

      # =====================================================================
      #  Format check (stable)
      # =====================================================================
      - name: Dart format check
        run: ${{ steps.cmds.outputs.format }}

      # ---------------------------------
      #  Test (stable)
      # ---------------------------------
      - name: Run tests
        run: ${{ steps.cmds.outputs.test }}

      # ---------------------------------
      #  CHANGELOG Ê†°È™å ÁâàÊú¨Âè∑Ôºà‰ªÖ releaseÔºâ
      # ---------------------------------
      - name: Validate CHANGELOG
        if: steps.tag.outputs.release == 'true'
        run: |

          if [ ! -f CHANGELOG.md ]; then
            echo "::error::CHANGELOG.md not found"
            exit 1
          fi

          if ! grep -q "^## ${{ steps.tag.outputs.version }}" CHANGELOG.md; then
            echo "::error::CHANGELOG.md missing version ${{ steps.tag.outputs.version }}"
            exit 1
          fi

      # ---------------------------------
      #  Publish (release only)
      # ---------------------------------

      - name: Publish dry-run
        if: steps.tag.outputs.release == 'true'
        run: ${{ steps.cmds.outputs.pub }} publish --dry-run

      - name: Publish
        if: steps.tag.outputs.release == 'true'
        run: ${{ steps.cmds.outputs.pub }} publish --force